---
title: "Smeltz 2023 LC PFAS RED Data"
author: "John Wambaugh"
date: "April 26, 2023"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Smeltz 2023 RED Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  wambaugh.john@epa.gov

# Here's the new R package for analyzing these data:
```{r load_packages, eval = TRUE}  
    library(invitroTKstats)
    
    # There are multiple packages for loading Excel files, but I've been using this
    # one lately:
    library(readxl)
```

    # Clear memory:
```{r clear_memory, eval = TRUE}     
    rm(list=ls())
```

Note that the following code chunks describe how the data.frame smeltz2023.red
was created. Since we have already created this "level1" file we can just load
it from the invitroTKstats package. Any chunk that includes the statement 
"eval = FALSE" is not evaluated when the vignette is created.

    # Change to the directory that has your Excel file 
    # (this is where it is on my computer):
```{r set_working_directory, eval = FALSE}   
    setwd("c:/users/jwambaug/git/invitroTKstats/working/SmeltzPFAS")
``` 

# Load chemical data:
```{r load_data, eval = FALSE}  
chem.ids <- read_excel("PFAS LC-MS RED Summary 20220709.xlsx", sheet=1, skip=1)[1:29,1:2]
chem.ids <- as.data.frame(chem.ids)
chem.ids <- subset(chem.ids, !duplicated(chem.ids[,2]))
 
this.file <- "PFAS LC-MS RED Summary 20220709.xlsx"
smeltz.red <- NULL
for (this.sheet in c(3,5,7,9))
{
  smeltz.red1 <- read_excel(this.file, sheet=this.sheet, skip=6)

  this.sheet.name <- excel_sheets(this.file)[this.sheet]
  smeltz.red1 <- as.data.frame(smeltz.red1)
  this.compound <- "DTXSID00379268"
  this.row <- 1
  while(this.row <= dim(smeltz.red1)[1])
  {
    if (!is.na(smeltz.red1[this.row,1]))
    {
      if (regexpr("Compound",smeltz.red1[this.row,1])!=-1)
      {
        temp <- trimws(strsplit(smeltz.red1[this.row,1],": ")[[1]][2])
        this.compound <- unique(chem.ids[regexpr(paste0("\\(",temp,"\\)"),chem.ids[,2])!=-1,1])
        if (length(this.compound)==0) this.compound <- temp
      } else 
      {  
        smeltz.red1[this.row,"DTXSID"] <- this.compound
      }
   }
   this.row <- this.row + 1
  }
  smeltz.red1$File <- this.file
  smeltz.red1$Sheet <- this.sheet.name
  smeltz.red <- rbind(smeltz.red, smeltz.red1)
}
smeltz.red <- subset(smeltz.red,!is.na(DTXSID))
```

# Convert date and time to strings:
```{r times_to_strings, eval = FALSE}  
smeltz.red$Acq.Date <- as.Date(as.numeric(smeltz.red$Acq.Date),origin = "1899-12-30")
h <- floor(as.numeric(smeltz.red$Acq.Time)*24)
m <- as.character(floor((as.numeric(smeltz.red$Acq.Time)*24-h)*60))
m[is.na(m)] <- "00"
m[sapply(m,nchar)==1] <- paste("0",m[sapply(m,nchar)==1],sep="")
smeltz.red$Acq.Time <- paste(h,m,sep=":")
```

  
# Set reasonable precision:
```{r set_precision, eval = FALSE}  
for (this.col in c("Area", "Height", "IS Area", "RT", "%Dev",
                   "Response", "Coeff. Of Determination", "Std. Conc", "nM"))
  smeltz.red[,this.col] <- signif(as.numeric(smeltz.red[,this.col]),6)
```


# Set Compound Identities:
```{r compound_identities, eval = FALSE}
chem.ids$Compound <- unlist(lapply(strsplit(chem.ids[,2]," \\("),function(x) x[[1]])) 
for (this.id in unique(smeltz.red$DTXSID))
{
  if (this.id %in% chem.ids$DTXSID)
  {
    smeltz.red[smeltz.red$DTXSID==this.id,"Compound"] <- 
      chem.ids[chem.ids$DTXSID==this.id,"Compound"] 
  } 
}  
smeltz.red[smeltz.red$DTXSID=="n-Butylparaben", "Compound"] <- "n-Butylparaben"
smeltz.red[smeltz.red$DTXSID=="n-Butylparaben", "DTXSID"] <- "DTXSID3020209"
smeltz.red[is.na(smeltz.red$Compound), "Compound"] <- "ISTD"
```

# Match chemicals to their internal standards:
```{r match_istd, eval = FALSE}
test.chems <- unique(smeltz.red$DTXSID)
test.chems <- test.chems[regexpr("DTXSID",test.chems)!=-1]
for (this.chem in test.chems)
{
  this.data <- subset(smeltz.red,!is.na(smeltz.red[,"IS Area"]) &
                      DTXSID==this.chem)
  this.istd <- smeltz.red[sapply(smeltz.red$Area,
                                 function(x) this.data[1,"IS Area"]%in%x),
                                 "DTXSID"]    
  smeltz.red[smeltz.red$DTXSID==this.chem,"ISTD"] <- this.istd              
}

# Get rid of internal standard data:
smeltz.red <- subset(smeltz.red, Compound != "ISTD")
```

# Use invitroTKstats annotation of type:
```{r UC_set_sample_types, eval=FALSE}
smeltz.red <- subset(smeltz.red,!is.na(smeltz.red[,"Sample Text"]))
smeltz.red[regexpr("CC",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "CC"
smeltz.red[regexpr("-Pl-",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "Plasma"
smeltz.red[regexpr("-S-",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "PBS"
smeltz.red[regexpr("-A",smeltz.red[,"Sample Text"])!=-1,
                   "Replicate"] <- "A"
smeltz.red[regexpr("-B",smeltz.red[,"Sample Text"])!=-1,
                   "Replicate"] <- "B"
smeltz.red[regexpr("-C",smeltz.red[,"Sample Text"])!=-1,
                   "Replicate"] <- "C"
smeltz.red[regexpr("-EC1-",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "EC1"                   
smeltz.red[regexpr("-EC2-",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "EC2"
smeltz.red[regexpr("/T1",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "T0"
smeltz.red[regexpr("/T5",smeltz.red[,"Sample Text"])!=-1,
                   "Sample.Type"] <- "Stability"
smeltz.red[regexpr("/T1",smeltz.red[,"Sample Text"])!=-1,
                   "Time"] <- 1
smeltz.red[regexpr("/T5",smeltz.red[,"Sample Text"])!=-1,
                   "Time"] <- 5
smeltz.red[regexpr("Crash Blank",smeltz.red[,"Sample Text"])!=-1,
                  "Sample.Type"] <- "NoPlasma.Blank"
smeltz.red[regexpr("Matrix Blank",smeltz.red[,"Sample Text"])!=-1,
                  "Sample.Type"] <- "Plasma.Blank"
```

# Smeltz Crash Blanks weren't analyzed in MS, set to zero:
```{r handle_crash_blanks, eval=FALSE}
smeltz.red[smeltz.red[,"Sample.Type"]%in%"NoPlasma.Blank","Area"] <- 0
smeltz.red[smeltz.red[,"Sample.Type"]%in%"NoPlasma.Blank","IS Area"] <- 1
```

# Blank analyte cells for matrix blanks for 8:2FTSA were zeros:
```{r correct_82FTSA, eval=FALSE}
smeltz.red[smeltz.red[,"Sample.Type"]%in%"Plasma.Blank" &
           smeltz.red$DTXSID=="DTXSID00192353", "Area"] <- 0
```

# Restrict to samples with peak areas for analyte and internal standard
```{r require_peaks, eval=FALSE}
smeltz.red[,"Std. Conc"] <- as.numeric(smeltz.red[,"Std. Conc"])
smeltz.red <- subset(smeltz.red, !is.na(Area) & 
  !is.na(smeltz.red[,"IS Area"]))
```

# Annotate dilution factors:
```{r annotate_dilution_facor, eval=FALSE}
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "CC" %in% x),"Dilution.Factor"] <- 1
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "PBS" %in% x),"Dilution.Factor"] <- 2
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "EC1" %in% x),"Dilution.Factor"] <- 10
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "EC2" %in% x),"Dilution.Factor"] <- 10
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "Plasma" %in% x),"Dilution.Factor"] <- 20
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "T0" %in% x),"Dilution.Factor"] <- 10
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "Stability" %in% x),"Dilution.Factor"] <- 10
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "Plasma.Blank" %in% x),"Dilution.Factor"] <- 1
smeltz.red[sapply(smeltz.red[,"Sample.Type"],function(x) "NoPlasma.Blank" %in% x),"Dilution.Factor"] <- 1
```

# Standard concentrations differ slightly from Protocol (CC17 = CC16, etc)
# Units should be uM:
```{r convert_units_for_standard, eval=FALSE}
smeltz.red[,"Std. Conc"] <- as.numeric(smeltz.red[,"Std. Conc"])/100
```

# 8:2 Fluorotelomer sulfonic acid:
```{r correct_82FTSA_2, eval=FALSE}
bad.samples <-which(smeltz.red$DTXSID=="DTXSID00192353")
# Set them all to the same date (therefore the same calibration):
smeltz.red[bad.samples,"Acq.Date"] <- smeltz.red[bad.samples[1],"Acq.Date"]
```

```{r format_and_annotate, eval=FALSE}
level1 <- format_fup_red(smeltz.red,
  FILENAME="SmeltzPFAS",
  sample.col ="Name",
  date.col="Acq.Date",
  compound.col="Compound",
  lab.compound.col="Compound",
  type.col="Sample.Type",
  dilution.col="Dilution.Factor",
  replicate.col="Replicate",
  cal=1,
  istd.conc = 10/1000,
  istd.col= "IS Area",
  istd.name.col = "ISTD", 
  std.conc.col = "Std. Conc", 
  level0.file.col = "File", 
  level0.sheet.col = "Sheet",
  test.nominal.conc = 10,
  plasma.percent = 100,
  time.col = "Time",
  analysis.method = "LCMS",
  analysis.instrument = "Waters ACQUITY I-Class UHPLC - Xevo TQ-S uTQMS",
  analysis.parameters = "RT",
  note.col=NULL
  )
# Produce errors if smeltz.red acccessed:
rm(smeltz.red)
```

```{r create_level2, eval=FALSE}
level2 <- level1
level2$Verified <- "Y"
```

# Extra data for 8:2 Fluorotelomer sulfonic acid needs to be ignored
# (first 54 sampes are okay):
# 8:2 Fluorotelomer sulfonic acid:
```{r correct_82FTSA_3, eval=FALSE}
bad.samples <-which(level2$DTXSID=="DTXSID00192353")
bad.samples <- bad.samples[44:length(bad.samples)]
level2[bad.samples,"Verified"] <- "Ignored"
```

# Some chemicals did not reach equilibrium (see Table 3):
```{r remove_noeq_chems, eval=FALSE}
level2[level2$DTXSID%in%c(
  "DTXSID3031860", # Perfluoro-3,6,9-trioxatridecanoic acid
  "DTXSID50375114", # Perfluoro-3,6,9-trioxatridecanoic acid	
  "DTXSID60892443", # Sodium perfluorodecanesulfonate
  "DTXSID1067629", # N-Methylperfluorooctanesulfonamide
  "DTXSID7027831", # N-Methyl-N-(2-hydroxyethyl) perfluorooctanesulfonamide 
  "DTXSID7040150", # Perfluorohexanesulfonic acid
  "DTXSID5061954", # 11-H-Perfluoroundecanoic acid
  "DTXSID8047553", # Perfluoroundecanoic acid 
  "DTXSID3059921", # Perfluorotetradecanoic acid
  "DTXSID90868151"), # Perfluorotridecanoic acid
  "Verified"] <- "Did not reach equilibrium"
```

```{r load_preprocessed_data_from_package, eval=TRUE}
level2 <- invitroTKstats::smeltz2023.red
```

```{r write_level2, eval=FALSE} 
write.table(level2,
  file="SmeltzPFAS-fup-RED-Level2.tsv",
  sep="\t",
  row.names=F,
  quote=F)
```

# maximum likelihood analysis:

The package has been undergoing further development since the example dataset `smeltz2023.red` was compiled. Some of the columns are named differently from how they were named in the previous version, or example, "Replicate" column is now called "Technical.Replicates" and "Std.Conc" column is now called "Test.Compound.Conc". Updating column names:
```{r}
colnames(level2)[which(colnames(level2) == "Std.Conc")] <- "Test.Compound.Conc"
colnames(level2)[which(colnames(level2) == "Replicate")] <- "Technical.Replicates"
```

```{r MLE, eval=TRUE}
level3 <- calc_fup_red_point(data.in = level2, 
                             output.res = FALSE)
```

# Bayesian analysis:
The following code can take a long time to run and so "eval = FALSE" is set
by default. You must manually run this code or change to "eval = TRUE".
```{r Bayes, eval=FALSE}
# repeat these bits in case a markov chain crashes and we need to restart:
library(invitroTKstats)
rm(list=ls())
setwd("c:/users/jwambaug/git/invitroTKstats/working/SmeltzPFAS")

level4 <- calc_fup_red(FILENAME="SmeltzPFAS",
                       NUM.CORES=8,
                       JAGS.PATH="C:/Users/jwambaug/AppData/Local/JAGS/JAGS-4.3.0/x64/bin/")  
```