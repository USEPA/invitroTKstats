---
title: "Crizer 2023 LC PFAS Clint Data"
author: "John Wambaugh"
date: "April 26, 2023"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Crizer 2023 Clint Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
wambaugh.john@epa.gov

# Here's the new R package for analyzing these data:
```{r load_packages, eval = TRUE}  
    library(invitroTKstats)
    
    # There are multiple packages for loading Excel files, but I've been using this
    # one lately:
    library(readxl)
```

    # Clear memory:
```{r clear_memory, eval = TRUE}     
    rm(list=ls())
```

Note that the following code chunks describe how the data.frame kreutz2023.clint
was created. Since we have already created this "level1" file we can just load
it from the invitroTKstats package. Any chunk that includes the statement 
"eval = FALSE" is not evaluated when the vignette is created.

    # Change to the directory that has your Excel file 
    # (this is where it is on my computer):
```{r set_working_directory, eval = TRUE}   
    setwd("c:/users/jwambaug/git/invitroTKstats/working/CrizerPFAS")
``` 
# Describe chemical tested:
```{r test_Chemicals, eval=TRUE}
chem.ids <- as.data.frame(read_excel("CrizerChemIDs.xlsx"))
```
# Load mass-spectrometry data:
```{r load_data, eval=TRUE}
data.guide <- as.data.frame(read_excel("dataguide-DC-hep.xlsx"))

dc.hep <- merge_level0(data.label="CrizerPFASHep",
# describe the MS data table:
             level0.catalog=data.guide,
             type.colname.col="Type.ColName",
             istd.col="ISTD.Name",
             analysis.param.colname.col="RT.ColName",
             additional.colnames="Note",
             additional.colname.cols="Note.ColName",
# describe the chemical ID table:
             chem.ids=chem.ids,
             chem.lab.id.col="Chemical",
             chem.name.col="Chemical",
             num.rows.col="Num.Rows")
```

```{r annotate_data}
# Set reasonable sig figs on retention time:
dc.hep$Analysis.Params <- signif(as.numeric(dc.hep$Analysis.Params), 6)

# Get rid of NA notes:
dc.hep[is.na(dc.hep$Note),"Note"] <- ""

# Use invitroTKstats annotation of type for Crizer lab samples:
dc.hep <- subset(dc.hep,!is.na(Type))
dc.hep[regexpr("std",tolower(dc.hep[,"Type"]))!=-1, "Sample.Type"] <- "CC"
dc.hep[(regexpr("blank", tolower(dc.hep[,"Sample"])) != -1 &
       regexpr("media", tolower(dc.hep[,"Sample"])) != -1), "Sample.Type"] <- 
       "Blank"
dc.hep[regexpr("unknown",tolower(dc.hep[,"Type"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("no_cells",tolower(dc.hep[,"Sample"]))!=-1, 
               "Sample.Type"] <- "Inactive"

# Use invitroTKstats annotation of type for wetmore lab samples:
dc.hep[dc.hep$Type %in% c("Standard"), "Sample.Type"] <- "CC"
dc.hep[dc.hep$Type %in% c("Blank"), "Sample.Type"] <- "Blank"
dc.hep[regexpr("t0-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t0-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t15-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t30-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t60-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t120-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("t240-",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Cvst"
dc.hep[regexpr("inactive",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- "Inactive"
dc.hep[regexpr("wem",tolower(dc.hep[,"Note"]))!=-1, 
               "Sample.Type"] <- NA

# Figure out from sample name whether the hepatocytes were alive:
# Indicate whether hepatocytes have been inactivated:
dc.hep$Active.Hep <- NA

 
# Add time of sample:
dc.hep <- subset(dc.hep,!is.na(dc.hep[,"Sample"]))
dc.hep[,"Time"] <- NA
dc.hep[regexpr("no_cells",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 240/60
# Do this time first since zeros show up in other names:
dc.hep[regexpr("0min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 0/60
dc.hep[regexpr("240min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 240/60
dc.hep[regexpr("120min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 120/60
dc.hep[regexpr("90min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 90/60
dc.hep[regexpr("60min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 60/60
dc.hep[regexpr("30min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 30/60
dc.hep[regexpr("15min",tolower(dc.hep[,"Sample"]))!=-1,"Time"] <- 15/60

# Annotate time for Wetmore samples:
dc.hep[regexpr("t0-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 0/60
dc.hep[regexpr("t15-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 15/60
dc.hep[regexpr("t30-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 30/60
dc.hep[regexpr("t60-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 60/60
dc.hep[regexpr("t120-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 120/60
dc.hep[regexpr("t240-",tolower(dc.hep[,"Note"]))!=-1,"Time"] <- 240/60

# Differentiate live hepatocytes from inactive:
dc.hep[dc.hep[,"Sample.Type"] %in% "Cvst", "Active.Hep"] <- 1
dc.hep[dc.hep[,"Sample.Type"] %in% "Inactive", "Active.Hep"] <- 0
```

# Identify Wetmore lab chemicals:
```{r wetmore_chems}
wetmore.files <- c(
  "Hep13-Hep14-to-JFW_PFAS.xlsx",
  "PFAS_20210902_Hep11_Data_to_JFW_20220318.xlsx")
```

# Set the dilution facor for the various samples:
```{r dilution_factors}
dc.hep$Dilution.Factor <- 1
dc.hep[!(dc.hep$Level0.File %in% wetmore.files) & 
       dc.hep[,"Sample.Type"] %in% c("Cvst","Inactive"), 
       "Dilution.Factor"] <- 4

dc.hep[dc.hep$Level0.File %in% wetmore.files,
  "Dilution.Factor"] <- 480

dc.hep[dc.hep$Level0.File %in% wetmore.files & 
       dc.hep$DTXSID %in% c(
  "DTXSID50226894",
  "DTXSID50379814",
  "DTXSID00880026"
  ),
  "Dilution.Factor"] <- 720

dc.hep[dc.hep$Level0.File %in% wetmore.files & 
       dc.hep$Sample.Type %in% c(
  "CC",
  "Blank"
  ),
  "Dilution.Factor"] <- 240
```


# Make sure the areas are numeric:
```{r numeric_peaks}
dc.hep$Peak.Area <- as.numeric(dc.hep$Peak.Area)
dc.hep$ISTD.Peak.Area <- as.numeric(dc.hep$ISTD.Peak.Area)
dc.hep[,"Compound.Conc"] <- as.numeric(dc.hep[,"Compound.Conc"])
```


# No ISTD for Crizer samples:
```{r no.istd}
dc.hep[!(dc.hep$Level0.File %in% wetmore.files),"ISTD.Peak.Area"] <- 1
```

# Second runs not used for Wetmore:
```{r not.really.blanks}
dc.hep[dc.hep$Type=="Blank" & 
       regexpr("blank",tolower(dc.hep$Note))==-1,"Sample.Type"] <- NA
```

# Convert nM standard concs to uM:
```{r nmtoum}
dc.hep[,"Compound.Conc"] <- as.numeric(dc.hep[,"Compound.Conc"])/1000
dc.hep[dc.hep$Sample.Type %in% c("Blank"), "Compound.Conc"] <- 0
```

```{r setinstruments}
dc.hep[!(dc.hep$Level0.File %in% wetmore.files),"Instrument"] <- "Waters Xevo TQ-S micro (QEB0036)"
dc.hep[(dc.hep$Level0.File %in% wetmore.files),"Instrument"] <- "Waters Xevo TQS-Micro UPLC-MS/MS"
```
# Create level 1 file:
```{r level1}
level1 <- format_clint(dc.hep,
  FILENAME="CrizerPFASHep",
  sample.col ="Sample",
  date.col="Date",
  compound.col="Compound",
  lab.compound.col="Lab.Compound.ID",
  type.col="Sample.Type",
  dilution.col="Dilution.Factor",
  cal.col="Date",
  istd.conc = 10/1000,
  area.col="Peak.Area",
  istd.col= "ISTD.Peak.Area",
  density = 0.5,
  clint.assay.conc = 1,
  note.col="Note",
  std.conc.col="Compound.Conc",
  time.col = "Time",
  analysis.method = "UPLC-MS/MS",
  analysis.instrument.col = "Instrument",
  analysis.parameters.col = "Analysis.Params"
  )
```

```{r create_level2file}
level2 <- level1
level2[!(level2$Level0.File %in% wetmore.files), "Verified"] <- "Y"
level2[(level2$Level0.File %in% wetmore.files), "Verified"] <- "Y"

level2[level2$Level0.File %in% wetmore.files &
       level2$DTXSID %in% c(
         "DTXSID50226894",
         "DTXSID50379814",
         "DTXSID00880026",
         "DTXSID70565479") &
       regexpr("WAX1",level2$Note)!=-1, "Verified"] <- "Not in WAX1"

level2[level2$Level0.File %in% wetmore.files &
       level2$DTXSID %in% c(
         "DTXSID90382620",
         "DTXSID1032646",
         "DTXSID80382154",
         "DTXSID40187142") &
       regexpr("WAX2",level2$Note)!=-1, "Verified"] <- "Not in WAX2"

level2[level2$Level0.File %in% wetmore.files &
       regexpr("Mobile Phase Blank",level2$Note)!=-1, "Verified"] <- "Ignored"

level2[level2$Level0.File %in% wetmore.files &
       regexpr("WAX SPE Matrix Blank",level2$Note)!=-1, "Verified"] <- "Ignored"

level2[level2$Level0.File %in% wetmore.files &
       regexpr("WAX SPE Blank",level2$Note)!=-1, "Verified"] <- "Ignored"

level2[level2$Level0.File %in% wetmore.files &
       regexpr("WAX QC-A",level2$Note)!=-1, "Verified"] <- "Ignored"

level2[level2$Level0.File %in% wetmore.files &
       regexpr("WAX QC-B",level2$Note)!=-1, "Verified"] <- "Ignored"

level2[sapply(level2[,"Note"], function(x) "Excluded" %in% x), 
              "Verified"] <- "Excluded"
level2[sapply(level2[,"Note"], function(x) "Response Low" %in% x), 
              "Verified"] <- "Excluded"


level2[level2$Lab.Sample.Name %in% c(
  "20220428_PFAS_Clint_Hep14_WAX_Sample005",
  "20220428_PFAS_Clint_Hep14_WAX_Sample006",
  "20220428_PFAS_Clint_Hep14_WAX_Sample012",
  "20220428_PFAS_Clint_Hep14_WAX_Sample013",
  "20220428_PFAS_Clint_Hep14_WAX_Sample014",
  "20220428_PFAS_Clint_Hep14_WAX_Sample016",
  "20220428_PFAS_Clint_Hep14_WAX_Sample017",
  "20220428_PFAS_Clint_Hep14_WAX_Sample018",
  "20220428_PFAS_Clint_Hep14_WAX_Sample020",
  "20220428_PFAS_Clint_Hep14_WAX_Sample021",
  "20220428_PFAS_Clint_Hep14_WAX_Sample022",
  "20220428_PFAS_Clint_Hep14_WAX_Sample024",
  "20220428_PFAS_Clint_Hep14_WAX_Sample025"), "Verified"] <- "Ignored"

write.table(level2,
  file="CrizerPFAS-Clint-Level2.tsv",
  sep="\t",
  row.names=F,
  quote=F)
```  

```{r plot_data}
for (this.id in unique(level2$DTXSID))
{
  this.subset <- subset(level2,DTXSID==this.id)
  try(plot(this.subset$Time,this.subset$Area,main=unique(this.subset$Compound.Name)))
}
```

```{r point_estimates}
level3 <- calc_clint_point(FILENAME="CrizerPFAS")
```

# repeat these bits in case a markov chain crashes and we need to restart:
```{r bayes_estimates}
library(invitroTKstats)
setwd("c:/users/jwambaug/git/invitroTKstats/working/CrizerPFAS")

level4 <- calc_clint(FILENAME="CrizerPFAS",
                          NUM.CORES=8,
                          JAGS.PATH="C:/Users/jwambaug/AppData/Local/JAGS/JAGS-4.3.0/x64")  
``` 