---
  title: "Kreutz 2022 GC PFAS Data"
author: "John Wambaugh"
date: "September 10, 2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Kreutz 2022}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---
  wambaugh.john@epa.gov

# Here's the new R package for analyzing these data:
```{r load_packages, eval = TRUE}  
    library(invitroTKstats)
    
    # There are multiple packages for loading Excel files, but I've been using this
    # one lately:
    library(readxl)
```

    # Clear memory:
```{r load_packages, eval = TRUE}     
    rm(list=ls())
```

    # Change to the directory that has your Excel file 
    # (this is where it is on my computer):
```{r set_working_directory, eval = TRUE}   
    setwd("c:/users/jwambaug/git/invitroTKstats/working/KreutzPFAS")
``` 

# Previously made scripts to load some data:
```{r set_working_directory, eval = TRUE}   
  suppressMessages(source("ak2.r"))
  AK.UCdata$DTXSID <- NA
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="915","DTXSID"] <- "DTXSID4059914"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="965","DTXSID"] <- "DTXSID60379269"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="476","DTXSID"] <- "DTXSID40379666"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="267","DTXSID"] <- "DTXSID10379991"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="3125","DTXSID"] <- "DTXSID70381151"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="906","DTXSID"] <- "DTXSID9059832"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="273","DTXSID"] <- "DTXSID0059871"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="913","DTXSID"] <- "DTXSID10382147"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="4NT","DTXSID"] <- "DTXSID5023792"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="899","DTXSID"] <- "DTXSID80382093"
  AK.UCdata$Compound.Name <- NA
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="915","Compound.Name"] <-
    "Heptafluorobutanol"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="965","Compound.Name"] <-
    "3-(Perfluoropropyl)propanol"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="476","Compound.Name"] <-
    "N-Methyl-N-trimethylsilylheptafluorobutyramide"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="267","Compound.Name"] <-
    "3-(Perfluorooctyl)propanol"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="3125","Compound.Name"] <-
    "Perfluorooctanamidine"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="906","Compound.Name"] <-
    "Dodecafluoroheptanol"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="273","Compound.Name"] <-
    "Pentafluoropropionamide"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="913","Compound.Name"] <-
    "3-(Perfluoro-2-butyl)propane-1,2-diol"
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="4NT","Compound.Name"] <- 
    "4-Nitrotoluene"  
  AK.UCdata[AK.UCdata$Lab.Compound.Name=="899","Compound.Name"] <- 
    "2-Aminohexafluoropropan-2-ol" 
  
# Really one calibration:
  AK.UCdata[AK.UCdata$Cal=="2020-02-04","Cal"] <- "2020-02-05"
  AK.UCdata[AK.UCdata$Cal=="2020-02-24","Cal"] <- "2020-02-25"

  level1.Dec2020 <- format_fup_uc(AK.UCdata,
    FILENAME="Kreutz2020",
    sample.col="Name",
    compound.col="Compound.Name", 
    lab.compound.col="Lab.Compound.Name", 
    type.col="Type", 
    std.conc.col="Target.Conc", 
    analysis.instrument.col="Instrument", 
    analysis.parameters.col="Analysis.Instrument.Param",
    uc.assay.conc = 10
    )

```
# Previously made scripts to load some data:
```{r set_working_directory, eval = FALSE}   
  suppressMessages(source("uc-test-AK.R"))
  all.data$Analysis.Parameters <- apply(all.data,1,function(x) paste("Analyte RT",x[11],"ISTD RT:",x[15]))
#  all.data$DTXSID <- NULL
#  all.data[all.data$Name=="Heptafluorobutyramide","DTXSID"] <- "DTXSID2060965" 
#  all.data[all.data$Name=="Nonafluoropentanamide","DTXSID"] <- "DTXSID60400587" 
#  all.data[all.data$Name=="Perfluoropentanamide","DTXSID"] <- "DTXSID70366226" 
#  all.data[all.data$Name=="Octafluoroadipamide","DTXSID"] <- "DTXSID80310730" 
#  all.data[all.data$Name=="Perfluorooctanamide","DTXSID"] <- "DTXSID60195123"  
  
  level1.Jul2020 <- format_fup_uc(all.data,
                                  uc.assay.conc = 10, 
                                  area.col = "Chem.Area", 
                                  compound.col="Name",
                                  std.conc.col="Standard.Conc",
                                  note.col="Comment",
                                  analysis.method="GCMS",
                                  analysis.instrument="Mystery GCMS")
``` 
# Previously made scripts to load some data:
```{r set_working_directory, eval = TRUE}   
  suppressMessages(source("uc-test-052920.R"))
  all.data$Lab.Compound.Name <- all.data$Compound.Name
  all.data$Date <- "April2019"
  all.data$DTXSID <- "DTXSID8031865"
  all.data[all.data$Compound.Name=="PFOS","DTXSID"] <- "DTXSID3031864"
  all.data$Compound.Name <- "Perfluorooctanoic acid"
  all.data[all.data$DTXSID == "DTXSID3031864","Compound.Name"] <- "Perfluorooctanesulfonic acid"
  level1.May2020 <- format_fup_uc(all.data,
                                  uc.assay.conc = 10, 
                                  area.col = "Area", 
                                  sample.col="Name",
                                  note.col="Sample.Text",
                                  compound.col="Compound.Name",
                                  std.conc.col="Std..Conc",
                                  analysis.parameters="RT",
                                  analysis.method="GCMS",
                                  analysis.instrument="Mystery GCMS",
                                  date.col="Date",
                                  istd.name="Unknown",
                                  istd.col="IS.Area",
                                  istd.conc=1)
```

# Assumed dilution factors:
```{r assay_information, eval=TRUE}
    CC.DILUTE <- 1
    BLANK.DILUTE <- 1
    AF.DILUTE <- 2*4
    T5.DILUTE <- 10*4
    T1.DILUTE <- 10*4
    ANALYSIS.METHOD <- "GCMS"
    ANALYSIS.INSTRUMENT <- "Mystery GC"
    ISTD.CONC <- 1 # uM
    UC.ASSAY.T0.CONC <- 10 # uM
```

    # list the data files:
```{r UC_data_files, eval=TRUE}
    files <- list("UC_474_760_3096_final.xlsx",
              "UC_503_507_516_501_505_521_510_120721.xlsx",
              "UC_513_268_275_812_121921.xlsx",
              "UC_763_945_274_964_464_477_479_final-ak.xlsx",
              "UC_908_909_916_923_3117_final-baw.xlsx",
              "UC_959_949_final-ak.xlsx"
              )
```

# Figure out the test chemical information:
```{r UC_chem_info, eval=TRUE}
    chem.start <- c(37, 37, 37, 37, 38, 38)
    cheminfo <- NULL
    for (this.file in files)
    {
      these.chems <- as.data.frame(read_excel(this.file,
               sheet=1,
               skip = chem.start[which(files==this.file)]))
      these.chems <- as.data.frame(subset(these.chems,
                            regexpr("DTXSID",Analyte)!=-1))
      this.reference <- NULL
      for (this.row in 1:dim(these.chems)[1])
      {
        if (!is.na(these.chems[this.row,"Reference Compound"]))
        {
          this.reference <- these.chems[this.row,"Reference Compound"]
        } else {
          these.chems[this.row,"Reference Compound"] <- this.reference
        }
      }
      this.istd <- NULL
      for (this.row in 1:dim(these.chems)[1])
      {
        if (!is.na(these.chems[this.row,"IS"]))
        {
          this.istd<- these.chems[this.row,"IS"]
        } else {
          these.chems[this.row,"IS"] <- this.istd
        }
      }
      these.chems$File <- this.file
      this.date <- suppressWarnings(suppressMessages(as.data.frame(
        read_excel(this.file,
               sheet=1,
               col_types="date",
               skip = 3))))[1,2]
      if (this.file == "UC_908_909_916_923_3117_final-baw.xlsx") this.date <- "2019-09-01"
      these.chems$Date <- this.date
      if (!("Flags" %in% colnames(these.chems))) these.chems$Flags <- NA
      if (!is.null(cheminfo)) these.chems <- these.chems[,colnames(cheminfo)]
      cheminfo <- rbind(cheminfo,these.chems)
    }



```

    # Define the info for control chemicals:
```{r UC_control_info, eval=TRUE}
for (this.file in files)
{
  this.control <-
    data.frame(
      Analyte = "DTXSID70160387",
      Name = "4-nitrotoluene",
      'Sample ID' = "4NT",
      IS = "13C6-4-nitrotoluene",
      "Reference Compound" = NA,
      "Avg. MW" = NA,
      "Flags" = NA,
      "File" = this.file)
    this.control$Date <- suppressWarnings(suppressMessages(
      as.data.frame(read_excel(this.file,
               sheet=1,
               col_types="date",
               skip = 3))))[1,2]
    colnames(this.control)[3] <- "Sample ID"
    colnames(this.control)[5] <- "Reference Compound"
    colnames(this.control)[6] <- "Avg. MW"
    cheminfo <- rbind(cheminfo,this.control)
}
```
    # Get rid of the UTC:
```{r fprmat_dates, eval=TRUE}
cheminfo[,"Date"] <- sapply(cheminfo[,"Date"],function(x) gsub("  UTC","",x))
```
                                         
    # Two of the data files keep all data in different columns of the "Data" sheet 
    # for each chemical's respective file.

    # Now loop over the files and annotate the data:
```{r UC_data_sheets, eval=TRUE}
    UC.data <- NULL
    
    for (this.file in files)
      if ("Data" %in% excel_sheets(this.file))
      {
          these.chems <- subset(cheminfo,File==this.file)
          for (this.chem in unique(
            these.chems$`Sample ID`))
          {
          these.data <- as.data.frame(
            suppressMessages(read_excel(this.file,
            sheet="Data")))
          start.col.name <- paste(this.chem,"Method")
          ANALYTE.OFFSET <- 4
          ISTD.OFFSET <- 7
          ANALYTE.RT.OFFSET <- 3
          ISTD.RT.OFFSET <- 6
          if (!(start.col.name %in% colnames(these.data)))
          {
            these.data <- as.data.frame(
              suppressMessages(read_excel(this.file,
              sheet="7bData")))
            ANALYTE.OFFSET <- 3
            ISTD.OFFSET <- 6
            ANALYTE.RT.OFFSET <- 2
            ISTD.RT.OFFSET <- 5
          }
          first.col <- which(colnames(these.data)==start.col.name)   
          this.chem.data <- these.data[
            ,c(first.col+ANALYTE.OFFSET,first.col+ISTD.OFFSET,first.col,3,7,6)]
          colnames(this.chem.data) <- c(
            "Area","ISTD.Area","NominConc","Lab.Sample.Name","Type","Note")
          this.chem.data$UC.Assay.T0.Conc <- UC.ASSAY.T0.CONC
          chem.index <- which(these.chems$`Sample ID` == this.chem)
          this.chem.data$Compound.Name <- these.chems[chem.index,"Name"]
          this.chem.data$Lab.Compound.Name <- this.chem
          this.chem.data$DTXSID <- these.chems[chem.index,"Analyte"]
          this.chem.data$ISTD.Name <- these.chems[chem.index,"IS"]
          this.chem.data$ISTD.Conc <- ISTD.CONC
          this.chem.data$Date <- these.chems[chem.index,"Date"]
          this.chem.data$Cal <- this.chem.data$Date
          this.chem.data$Analysis.Parameters <- paste(
            "Analyte RT:",
            signif(
              suppressWarnings(as.numeric(
              these.data[,first.col+ANALYTE.RT.OFFSET],5))),
            "ISTD RT:",
            signif(suppressWarnings(as.numeric(
              these.data[,first.col+ISTD.RT.OFFSET],5)))
            )
        UC.data <- rbind(UC.data,this.chem.data)
        }
      }  
```

# Handle the data for "UC_474_760_3096_final.xlsx"
```{r UC_final_four, eval=TRUE}
  this.file <- "UC_474_760_3096_final.xlsx"
  these.chems <- subset(cheminfo,File==this.file)
  new.data <- NULL
  this.chem <- "474"
  these.data <- as.data.frame(
    suppressMessages(read_excel(this.file,
    sheet="474Raw")))
  these.data$Lab.Compound.Name <- this.chem
  new.data <- rbind(new.data,these.data)
  this.chem <- "760"
  these.data <- as.data.frame(
    suppressMessages(read_excel(this.file,
    sheet="760Raw")))
  these.data$Lab.Compound.Name <- this.chem
  colnames(these.data) <- colnames(new.data)
  new.data <- rbind(new.data,these.data)
  this.chem <- "3096"
  these.data <- as.data.frame(
    suppressMessages(read_excel(this.file,
    sheet="3096Raw")))
  these.data$Lab.Compound.Name <- this.chem
  colnames(these.data) <- colnames(new.data)
  new.data <- rbind(new.data,these.data)
  this.chem <- "4NT"
  these.data <- as.data.frame(
    suppressMessages(read_excel(this.file,
    sheet="4NTRaw")))
  these.data$A <- these.data[,22]
  these.data$B <- NA
  these.data$C <- NA
  these.data$Lab.Compound.Name <- this.chem
  colnames(these.data) <- colnames(new.data)
  new.data <- rbind(new.data,these.data)
  new.data <- subset(new.data,new.data[,3]!="Name")
  
  this.chem.data <- new.data[,
    c(13,25,11,3,8,4)]
  colnames(this.chem.data) <- c(
    "Area","ISTD.Area","NominConc","Lab.Sample.Name","Type","Note")
  this.chem.data$UC.Assay.T0.Conc <- UC.ASSAY.T0.CONC
  for (this.chem in unique(new.data$Lab.Compound.Name))
  {
    which.rows <- new.data$Lab.Compound.Name == this.chem 
    chem.index <- which(these.chems$`Sample ID` == this.chem)
# Get rid of column header rows:
    this.chem.data[which.rows, "Compound.Name"] <- these.chems[
      chem.index,"Name"]
    this.chem.data[which.rows, "Lab.Compound.Name"] <- this.chem
    this.chem.data[which.rows, "DTXSID"] <- these.chems[
      chem.index,"Analyte"]
    this.chem.data[which.rows, "ISTD.Name"] <- these.chems[
      chem.index,"IS"]
    this.chem.data[which.rows, "ISTD.Conc"] <- ISTD.CONC
    this.chem.data[which.rows, "Date"] <- these.chems[
      chem.index,"Date"]
  }
  this.chem.data$Cal <- this.chem.data$Date
  this.chem.data$Analysis.Parameters <- paste(
            "Analyte RT:",
            signif(suppressWarnings(as.numeric(
              new.data[,12],5))),
            "ISTD RT:",
            signif(suppressWarnings(as.numeric(
              new.data[,24],5)))
            )
  UC.data <- rbind(UC.data,this.chem.data)  
  dim(UC.data)
```

```{r UC_finish, eval=TRUE}
# Try again to get rid of column header rows:
  UC.data <- subset(UC.data,Type!="Type")
  dim(UC.data)
  
# Make the peak area numeric and set a reasonable precision:
  UC.data$Area <- signif(
    suppressWarnings(as.numeric(UC.data$Area)))
  UC.data$ISTD.Area <- signif(
    suppressWarnings(as.numeric(UC.data$ISTD.Area)))

# Annotate instrument:
 UC.data$Analysis.Method <- ANALYSIS.METHOD
  UC.data$Analysis.Instrument <- ANALYSIS.INSTRUMENT

  # Extract the sample type from column Sample Text:
  for (this.replicate in c("a","b","c"))
    for (this.type in c("T1","T5","AF"))
    {
      this.string <- paste(this.type,this.replicate,sep="")
      which.rows <- regexpr(this.string,
                      unlist(UC.data[,"Lab.Sample.Name"]))!=-1
      UC.data[which.rows, "Sample.Type"] <- this.type
      UC.data[which.rows, "Replicate"] <- this.replicate
    }

  # Annotate series:
  UC.data$Series <- NA
  for (this.series in 1:3)
  {
    this.string <- paste("S",this.series,sep="")
    which.rows <- regexpr(this.string, unlist(UC.data[,"Lab.Sample.Name"]))!=-1
    UC.data[which.rows, "Series"] <- this.series
  }
    
  UC.data[UC.data$Type == "Cal","Sample.Type"] <- "CC"
  UC.data[UC.data$Type == "MatrixBlank","Sample.Type"] <- "Blank"

  # Get rid of unused samples (QC samples):
  UC.data <- subset(UC.data,!is.na(Sample.Type))


# Convert to uM:
  UC.data[,"Std.Conc"] <- suppressWarnings(as.numeric(UC.data[,"NominConc"]))/1000
  UC.data[,"Std.Units"] <- "uM" 
  UC.data[UC.data[,"Sample.Type"]!="CC","Std.Units"] <- NA 
  UC.data[UC.data[,"Sample.Type"]!="CC","Std.Conc"] <- NA 

# We'll need to go back and set this per sample type:
UC.data[UC.data[,"Sample.Type"]=="AF","Dilution.Factor"] <- AF.DILUTE
UC.data[UC.data[,"Sample.Type"]=="T1","Dilution.Factor"] <- T1.DILUTE
UC.data[UC.data[,"Sample.Type"]=="T5","Dilution.Factor"] <- T5.DILUTE
UC.data[UC.data[,"Sample.Type"]=="CC","Dilution.Factor"] <- CC.DILUTE
UC.data[UC.data[,"Sample.Type"]=="Blank","Dilution.Factor"] <- BLANK.DILUTE

# Treat the blanks as calibration data with concentration 0:
UC.data[UC.data[,"Sample.Type"]=="Blank","Std.Conc"] <- 0
UC.data[UC.data[,"Sample.Type"]=="Blank","Std.Units"] <- "uM"
    
UC.data[UC.data[,"Sample.Type"]=="Blank","Sample.Type"] <- "CC"
dim(UC.data)
    
# Get rid of CC samples that don't have a concentration:
UC.data <- subset(UC.data,!(Sample.Type=="CC" & is.na(Std.Conc)))
    
dim(UC.data)
    
write.table(UC.data,file="KreutzPFAS-PPB-UC-Level0.tsv",sep="\t",row.names=FALSE)
```

```{r format_and_annotate, eval=TRUE}
    level1 <- format_fup_uc(UC.data,
      FILENAME="KreutzPFAS",
      sample.col="Lab.Sample.Name",
      compound.col="Compound.Name",
      std.conc.col="Std.Conc", 
      lab.compound.col="Lab.Compound.Name", 
      type.col="Sample.Type", 
      istd.col="ISTD.Area",
      note.col="Note",
      uc.assay.conc.col="UC.Assay.T0.Conc"
      )

    level1 <- rbind(level1,level1.May2020,level1.Dec2020)
    level2 <- level1
    # Taking all data in spreadsheet as human verified for starters
    level2$Verified <- "Y"
    # From Anna:
    # UC_513_268_275_812_121921.xlsx
    # something appears off w/ AFS2a- exclude
    which.rows <- regexpr("S2 AFa",level2$Lab.Sample.Name)!=-1 &
      level2$Date == "2021-10-06"
    level2[which.rows,"Verified"] <- "AK: something appears off w/ AFS2a"

    # If not response in assay sample assume bad:
    for (this.type in c("T1","T5"))
    {
      which.rows <- level2$Sample.Type==this.type & level2$Area==0
      which.rows[is.na(which.rows)] <- FALSE
      level2[which.rows,"Verified"] <- "JFW: Excluded for no response"
    }
    
    write.table(level2,
      file="KreutzPFAS-PPB-UC-Level2.tsv",
      sep="\t",
      row.names=F,
      quote=F)
```

# maximum likelihood analysis:
```{r MLE, eval=TRUE}
    level3 <- calc_fup_uc_point(FILENAME="KreutzPFAS") 
    write.table(level3,
      file="KreutzPFAS-PPB-UC-Level3.tsv",
      sep="\t",
      row.names=F,
      quote=F)
```

# Bayesian analysis:
```{r Bayes, eval=TRUE}
    
    library(invitroTKstats)
    setwd("c:/users/jwambaug/git/invitroTKstats/working/")
    level4 <- calc_fup_uc(FILENAME="KreutzPFAS") 
```